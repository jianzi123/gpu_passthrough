---
# Configure memory settings

- name: Set Transparent Huge Pages
  shell: |
    echo {{ thp_enabled }} > /sys/kernel/mm/transparent_hugepage/enabled
    echo {{ thp_defrag }} > /sys/kernel/mm/transparent_hugepage/defrag
  changed_when: true

- name: Configure sysctl parameters for memory
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_file: /etc/sysctl.d/99-gpu-performance.conf
    reload: yes
  loop:
    - { name: 'vm.swappiness', value: "{{ vm_swappiness }}" }
    - { name: 'vm.dirty_ratio', value: "{{ vm_dirty_ratio }}" }
    - { name: 'vm.dirty_background_ratio', value: "{{ vm_dirty_background_ratio }}" }

- name: Verify memory settings
  shell: |
    echo "THP Enabled: $(cat /sys/kernel/mm/transparent_hugepage/enabled)"
    echo "THP Defrag: $(cat /sys/kernel/mm/transparent_hugepage/defrag)"
    echo "Swappiness: $(cat /proc/sys/vm/swappiness)"
  register: memory_settings
  changed_when: false

- name: Display memory settings
  debug:
    var: memory_settings.stdout_lines
