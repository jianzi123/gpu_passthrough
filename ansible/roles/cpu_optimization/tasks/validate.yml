---
# Validation tasks

- name: Validate CPU governor
  shell: cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
  register: final_governor
  changed_when: false

- name: Validate Turbo status
  shell: |
    if [ -f /sys/devices/system/cpu/intel_pstate/no_turbo ]; then
        cat /sys/devices/system/cpu/intel_pstate/no_turbo
    elif [ -f /sys/devices/system/cpu/cpufreq/boost ]; then
        cat /sys/devices/system/cpu/cpufreq/boost
    else
        echo "unknown"
    fi
  register: final_turbo
  changed_when: false

- name: Validate memory settings
  shell: |
    cat /proc/sys/vm/swappiness
  register: final_swappiness
  changed_when: false

- name: Display validation results
  debug:
    msg:
      - "CPU Governor: {{ final_governor.stdout }}"
      - "Turbo Status: {{ final_turbo.stdout }}"
      - "Swappiness: {{ final_swappiness.stdout }}"

- name: Create validation summary
  copy:
    dest: /var/log/cpu-optimization-summary.txt
    content: |
      CPU Optimization Summary
      Generated: {{ ansible_date_time.iso8601 }}

      CPU Governor: {{ final_governor.stdout }}
      Turbo Status: {{ final_turbo.stdout }}
      Swappiness: {{ final_swappiness.stdout }}
      NUMA Nodes: {{ numa_node_count | default('unknown') }}

      Kernel Parameters Applied:
      {{ kernel_params_string | default('none') }}
    mode: '0644'
