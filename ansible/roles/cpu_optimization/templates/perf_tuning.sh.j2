#!/bin/bash
# GPU Server Performance Tuning Script
# Auto-generated by Ansible
# Date: {{ ansible_date_time.iso8601 }}

set -e

echo "Applying GPU server performance tuning..."

# Set CPU Governor
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
    if [ -f "$cpu" ]; then
        echo {{ cpu_governor }} > "$cpu" 2>/dev/null || true
    fi
done

# Enable Turbo Boost
{% if enable_turbo_boost %}
if [ -f /sys/devices/system/cpu/intel_pstate/no_turbo ]; then
    echo 0 > /sys/devices/system/cpu/intel_pstate/no_turbo
elif [ -f /sys/devices/system/cpu/cpufreq/boost ]; then
    echo 1 > /sys/devices/system/cpu/cpufreq/boost
fi
{% endif %}

# Set Transparent Huge Pages
echo {{ thp_enabled }} > /sys/kernel/mm/transparent_hugepage/enabled
echo {{ thp_defrag }} > /sys/kernel/mm/transparent_hugepage/defrag

# Apply sysctl settings
sysctl -w vm.swappiness={{ vm_swappiness }}
sysctl -w vm.dirty_ratio={{ vm_dirty_ratio }}
sysctl -w vm.dirty_background_ratio={{ vm_dirty_background_ratio }}

echo "Performance tuning applied successfully"
